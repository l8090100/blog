---
templateKey: 'blog-post'
title: 'PLC project 01'
date: 2019-09-21
featuredpost: false
featuredimage: 
description: >-
  整理PLC教具專案的建置過程。
tags:
  - PLC
  - AutoControl
  - Modbus
---
![chemex](/img/blog1.jpg)

# PLC教具專案
***
- [系統架構](#系統架構)
  - [硬體](#硬體)
    - [電力箱](#電力箱)
    - [PLC控制主機](#PLC控制主機)
    - [變頻器](#變頻器)
    - [馬達](#馬達)
    - [編碼器](#編碼器)
  - [軟體](#軟體)
    - [設置環境](#設置環境)
    - [ModbusTCP](#ModbusTCP)
    - [PLC程式解析](#PLC程式解析)
    - [Node-RED](#Node-RED)
    - [系統使用步驟](#系統使用步驟)


# 系統架構

## 架構規劃
PLC教具主位是給劇場設計的學生使用，讓學生透過簡單的PLC程式撰寫，在經過設計的
運動模擬機構上，展示多種舞台常用的自動控制功能。

+ 馬達電力需求：[3相480V](https://zh.wikipedia.org/wiki/%E4%B8%89%E7%9B%B8%E9%9B%BB)
+ 控制系統電力需求：[單相110V](https://zh.wikipedia.org/wiki/%E5%96%AE%E7%9B%B8%E9%9B%BB)
+ PLC型號：[FX5U-32M](https://www.fapro.com.tw/p2-product-detail.asp?cid=2&tid=2&nid=460&ppage=) 
+ 馬達型號：[BHI62U-G2](https://sg.misumi-ec.com/vona2/detail/221000802432/?HissuCode=BHI62U-G2)
+ 減速機型號：[BH6G2-25RH](https://www.orientalmotor.com.tw/products/ac/list/detail/?product_name=BHI62F-25RH&brand_tbl_code=AC&series_code=0600&type_code=)
+ 變頻器：[FR-D740](https://www.seec.com.tw/Content/Goods/GCont.aspx?SiteID=10&MmmID=655575436061073254&CatId=2015121009215851581&MSID=655632441757735143#ad-image-0)
+ 絕對型旋轉編碼器：[EC6P-AG5C](https://www.omron.com.tw/products/family/494/lineup.html)
+ 控制介面：[Node-RED](https://nodered.org/)
+ PLC編程：[功能區塊圖 FBD](https://zh.wikipedia.org/wiki/%E5%8A%9F%E8%83%BD%E5%8D%80%E5%A1%8A%E5%9C%96)
+ 控制通訊介面：[Modbus TCP](https://zh.wikipedia.org/wiki/Modbus)
  
## 電力
一般劇場都會提供3相480V的電源讓自動控制設備使用，戶外演出時擇時會遇到3相220V或單相220V的電源，使用者可以根據不同的場地的電力設備挑選適合的馬達，也可以自己搭配適合馬達的動力箱，此專案採用後者，客製化了一個動力箱，此動力箱包含了3相480V和單相220V的電源，可以帶到不同場地並搭配不同電力需求的馬達使用。
## PLC控制主機
舊式PLC大多要透過專用的線材燒錄程式與通訊，只要遺失就得費時費力取得專用線材。為了簡化開發的時間與成本，改買可以使用網路線燒綠程式的新型PLC，也不需要網路外加模組便能用網路通訊。
## 編碼器
為了知道馬達目前位置，使用絕對型[旋轉編碼器](https://zh.wikipedia.org/wiki/旋轉編碼器)偵測位置，如果用相對型編碼器，系統斷電後馬達如果還有移動就無法得知絕對位置，但絕對型編碼器每個角度都有編碼，不會有這個問題。需要注意的是，這次採用的編碼器為NPN型，PLC的控制迴路也必須為NPN型才能讀到編碼器的編碼訊號。
# 軟體
- [控制與監控介面](##控制與監控介面)
- [設置環境](##設置環境)
- [PLC程式解析](##PLC程式解析)
## Node-RED
Node-RED是IBM基於Node.js開發的視覺化物聯網開發工具，它可以用滑鼠拖拉的方式編寫程式，也可以添加Java-Script程式碼實現特殊功能。為了用最簡單的方式理解PLC通訊和使用者介面(GUI)之間的關係，這次的專案並沒有重新開發桌面應用軟體，而是使用現成的物聯網開發套件和PLC溝通。
1.  讀PLC接點
2.  讀變頻器狀態
3.  控制變頻器正反轉
4.  設定四個極限定位與頻率
5.  計算實際轉速
### ModbusTCP
Modbus TCP是基於TCP/IP的工業通訊協定，常用來和PLC交換資料，網路上有許多針對不同程式語言包裝好的Modbus函式庫，方便做工業控制的應用開發。Modbus協定有許多不同功能碼來讀寫PLC的不同資料，以下是常用的功能碼，此專案用到01,03,05,06,15。

功能碼|功能|說明
:---------:|:-----|:----
01| 讀 線圈寄存器   |起始位置8192 = M0
02| 讀 離散輸入寄存器|
03| 讀 保持寄存器   |起始位置0 = D0
04| 讀 輸入寄存器   |
05| 寫 單個線圈寄存器|起始位置8192 = M0
06| 寫 單個保持寄存器|起始位置0 = D0
15| 寫 多個線圈寄存器|起始位置8192 = M0
16| 寫 多個保持寄存器|

## 接線
PLC 有許多的輸入和輸出接點，透過程式設計出各種控制邏輯。X接點為輸入接點，Y接點則為輸出接點，接線前先確認這次專案輸出元件，是共陽還是共陰級的設計。例如這次專案展示的絕對型編碼器就是NPN接線，因此其他的帶燈按鈕也必須使用NPN邏輯和24V電源供應器組成控制電路。輸入模組上的S/S接點接到24V就等於把PLC設定為NPN漏型輸入模式。
[NPN和PNP差別]
[NPN接線範例]
[PNP接線範例]
PLC和變頻器的通訊線也要自己製作，通訊方式是使用RS485串列通訊RX/TX，用RJ45網路線接頭和網路線製作即可。
![變頻器通訊接線圖]
![PLC通訊接線圖]
變頻器有提供一些外部輸入控制的接點，只要把控制開關街上去就能手動控制變頻器的正反轉。
![變頻器控制接線圖](https://lh3.googleusercontent.com/uG2DlsdbK_qqq0E_3hgbDgnDzC-VorYlu_JLgOM56X5dXlyVsGM6kNUp2d3CkGVRU0sH72WkOKUMX9Lrj_USYOWkqZiwKIsxFn3r7XpCDqhQp56qqymHXAc5qxoOgq4BYXg8ommGjHc=w1432-h937-no)

電腦和PLC的通訊用一般的網路線即可，每台PLC都有自己的網路IP，在設定網路時要特別注意。
## 設置環境
1.  安裝[GXWork3](https://www.fapro.com.tw/p3-news-detail.asp?nid=121)，撰寫PLC程式。
2.  完成[PLC的Modbus TCP通訊設定](https://kknews.cc/zh-tw/news/eknnl4q.html)，並[修改PLC的預設IP](http://bbs.gkong.com/archive.aspx?id=455676)。
3.  完成PLC和變頻器的通訊設定。
4.  參考網路資源[安裝Node-RED](https://kknews.cc/zh-tw/news/eknnl4q.html)，並[安裝Modbus外掛](https://flows.nodered.org/node/node-red-contrib-modbus)，才能和PLC通訊並存取內部資料。
5.  在Node-RED裡設定Modbus TCP伺服器。

## 系統使用步驟
1.  電腦開機
2.  控制系統上電
3.  確認控制模式切換開關為通訊模式
4.  雙擊 Node.js command prompt
5.  輸入 `node-red` + `Enter`執行Node-RED
6.  打開瀏覽器，網址列輸入 `127.0.0.1:1880`
7.  確認Modbus 伺服器的IP為`192.168.1.111`
8.  確認橘色圖塊下面的小字為綠點加上`Active`
9.  網址列輸入 `127.0.0.1:1880/ui`後即可看到控制介面
10. 開始控制馬達。
11. 
## PLC程式解析

### 功能簡介
這次的PLC專題包含了10種功能，並沒有嚴格的排序問題，對於剛接觸PLC的新手，以下功能已包含許多常用的PLC控制指令與邏輯，在撰寫時也力求簡潔，方便以後設計擴充功能時有較清楚的參考。

- [燈號判斷](#燈號判斷)
- [手自動模式判斷](#手自動模式判斷)
- [控制模式判斷](#控制模式判斷)
- [極限模式設定速度子程式](#極限模式設定速度子程式)
- [讀編碼器位置](#讀編碼器位置)
- [重點參數設定](#重點參數設定)
- [定位完成判斷](#定位完成判斷)
- [讀變頻器狀態](#讀變頻器狀態)
- [變頻馬達控制指令偵測](#變頻馬達控制指令偵測)
- [表演模式按鈕狀態判斷](#表演模式按鈕狀態判斷)

### 用FBD語言寫程式
PLC最常用的編程語言叫做階梯圖，除了歷史悠久外學習資源也非常多。唯有一個缺點是維護不便，當程式越來越龐大和複雜時，傳統階梯圖的除錯效率會越來越差。這次為了讓程式更圖形化和容易維護，改用[功能區塊圖](https://zh.wikipedia.org/wiki/%E5%8A%9F%E8%83%BD%E5%8D%80%E5%A1%8A%E5%9C%96)（Function Block Diagram，簡稱FBD）編程。FBD有兩個優點，一個是修改方便，一個是可以將複雜的子程式變成一個模塊，讓主程式只顯式最重要的參數。

### 燈號判斷
燈號的功能對劇場機械的自動控制來說，演出中執行的操作員只需要知道

1.  系統是否正常
1.  訊號送出去了沒
1.  機器到定位了沒

除了這些資訊，並不需要其他複雜的燈號。此段程式所判斷的，便是這三種訊息。
### 手自動模式判斷
劇場控制機械時常常要切換手動測試或運行，此段程式透過切換按鈕判斷藥用介面還是手動控制馬達。我們從PLC發送指令給變頻器來切換手自動模式，並使用變頻器自帶的正反轉輸入接點、可變電阻輸入接點，簡單的調整變頻器正反轉與頻率。
### 控制模式判斷
包含兩種控制馬達的模式，兩種模式都會儲存並回傳當前馬達運行的狀態。
#### 按鈕控制
點擊介面按鈕後，會傳送不同的控制訊號給PLC，並判斷馬達正反轉和停止。
#### 極限定位模式
讓PLC程式判斷，馬達走到哪個極限再停止。其中經過的極限能設定不同速度，讓運動過程中有不同的速度變化。
### 控制模式速度判斷
此段程式可以讓物件在極限定位模式下，經過極限時改變運動頻率，按鈕控制模式下則使用該模式的頻率。
### 讀編碼器位置
此款絕對型編碼器有八條訊號線，每條線代表[格雷碼](https://kknews.cc/zh-tw/news/x869qo9.html)的一位數，PLC讀取八個接點的0,1便能解碼出實際位置。
### 重點參數設定
這段簡單的設定參數到寄存器程式，將控制變頻器的重要參數紀錄在此方便查閱，就不用一一到控制指令圖塊找尋實際參數的值。
### 定位完成判斷
在介面選擇在哪個極限停止後，資料會存在PLC並判斷該極限是否被撞到，撞到的話就判斷為定位完成，並把資料歸零等待下一次的定位需求。
### 讀變頻器狀態
此段程式負責發出讀取變頻器狀態的請求，包含運行模式、輸出電流、輸出頻率、輸出電壓、異常內容、狀態監視、設定頻率。
### 變頻馬達控制指令偵測
此部分的程式碼負責偵測馬達正反轉和停止的訊號，收到符合條件的觸發訊號後便發送控制指令給變頻器。
### 表演模式按鈕狀態判斷
此段程式並沒有結合馬達控制功能，主要展示兩種功能
1.  將實體按鈕和介面燈號連結，模擬表演開始、暫停和停止的燈號。
1.  利用PLC內建功能，實現按同一個按鈕顯示兩種不同亮燈效果。
